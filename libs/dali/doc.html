<html>
	<head>
		<title>Dali</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
		<style>body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    color: #252519;
}
a {
    color: #252519;
}
a:hover {
    text-decoration: underline;
    color: #19469D;
}
p {
    margin: 12px 0;
}
h1, h2, h3 {
    margin: 0;
    padding: 0;
}
table#source {
    width: 100%;
    border-collapse: collapse;
}
table#source td:first-child {
    padding: 30px 40px 30px 40px;
    vertical-align: top;
}
table#source td:first-child,
table#source td:first-child pre {
    width: 450px;
}
table#source td:last-child {
    padding: 30px 0 30px 40px;
    border-left: 1px solid #E5E5EE;
    background: #F5F5FF;
}
table#source tr {
    border-bottom: 1px solid #E5E5EE;
}
table#source tr.filename {
    padding-top: 40px;
    border-top: 1px solid #E5E5EE;
}
table#source tr.filename td:first-child {
    text-transform: capitalize;
}
table#source tr.filename td:last-child {
    font-size: 12px;
}
table#source tr.filename h2 {
    margin: 0;
    padding: 0;
    cursor: pointer;
}
table#source tr.code h1,
table#source tr.code h2,
table#source tr.code h3 {
    margin-top: 30px;
    font-family: "Lucida Grande", "Helvetica Nueue", Arial, sans-serif;
    font-size: 18px;
}
table#source tr.code h2 {
    font-size: 16px;
}
table#source tr.code h3 {
    font-size: 14px;
}
table#source tr.code ul {
    margin: 15px 0 15px 35px;
    padding: 0;
}
table#source tr.code ul li {
    margin: 0;
    padding: 1px 0;
}
table#source tr.code ul li p {
    margin: 0;
    padding: 0;
}
table#source tr.code td:first-child pre {
    padding: 20px;
}
#ribbon {
    position: fixed;
    top: 0;
    right: 0;
}
code .string { color: #219161; }
code .regexp { color: #219161; }
code .keyword { color: #954121; }
code .number { color: #19469D; }
code .comment { color: #bbb; }
code .this { color: #19469D; }</style>
		<script>
			$(function(){
				$('tr.code').hide();
				$('tr.filename').toggle(function(){
					$(this).nextUntil('.filename').fadeIn();
				}, function(){
					$(this).nextUntil('.filename').fadeOut();
				});
			});
		</script>
	</head>
	<body>
<table id="source"><tbody><tr><td><h1>Dali</h1></td><td></td></tr><tr class="filename"><td><h2 id="src/dali.js"><a href="doc.html#">dali</a></h2></td><td>src/dali.js</td></tr><tr class="code">
<td class="docs">
<pre><code>Dali - Javascript Templating Engine

See readme.txt for documentation</code></pre>
</td>
<td class="code">
<pre><code>(<span class="keyword">function</span> (<span class="variable">exportContent</span>) {</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<pre><code> * Create an Dali instance. Each instance has its own set templates and config.
 * @constructor
 </code></pre>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Dali</span>(<span class="variable">options</span>) {
		<span class="comment">// todo: simplify the dali constructor... less like jQuery</span>

		<span class="keyword">var</span> <span class="variable">dali</span> = <span class="this">this</span>;

		<span class="this">this</span>.<span class="variable">templates</span> = {};
		<span class="this">this</span>.<span class="variable">tags</span> = <span class="variable">tags</span>;
		<span class="this">this</span>.<span class="variable">decorators</span> = <span class="variable">decorators</span>;
		<span class="this">this</span>.<span class="variable">version</span> = &<span class="variable">quot</span>;<span class="number float">0.1</span>&<span class="variable">quot</span>;;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<pre><code>	 * Constructor for individual templates
	 * @constructor
	 </code></pre>
</td>
<td class="code">
<pre><code><span class="this">this</span>.<span class="class">Template</span> = <span class="keyword">function</span> <span class="class">Template</span>(<span class="variable">id</span>, <span class="variable">source</span>, <span class="variable">environ</span>, <span class="variable">options</span>) {
			<span class="keyword">var</span> <span class="variable">template</span> = <span class="this">this</span>;
			<span class="this">this</span>.<span class="variable">id</span> = <span class="variable">id</span>;
			<span class="this">this</span>.<span class="variable">source</span> = <span class="variable">source</span>;
			<span class="this">this</span>.<span class="variable">environ</span> = <span class="variable">environ</span>;
			<span class="this">this</span>.<span class="variable">handler</span> = <span class="variable">compile</span>();

			<span class="this">this</span>.<span class="variable">render</span> = <span class="keyword">function</span> <span class="variable">render</span>(<span class="variable">data</span>) {
				<span class="keyword">var</span> <span class="variable">env</span> = <span class="keyword">new</span> <span class="class">Env</span>();
				<span class="keyword">return</span> <span class="this">this</span>.<span class="variable">handler</span>.<span class="variable">call</span>(<span class="variable">data</span>, <span class="variable">env</span>);
			};

			<span class="keyword">function</span> <span class="variable">compile</span>() {
				<span class="comment">//console.log(&quot;Template source: \n&quot;, source);</span>
				<span class="keyword">var</span> <span class="variable">source</span> = <span class="variable">lexer</span>(<span class="variable">escape</span>(<span class="variable">template</span>.<span class="variable">source</span>)) +
						&<span class="variable">quot</span>;<span class="keyword">return</span> <span class="variable">env</span>.<span class="variable">stream</span>();\<span class="variable">n</span>&<span class="variable">quot</span>;;
				<span class="comment">//console.log(source);</span>
				<span class="keyword">return</span> <span class="keyword">new</span> <span class="class">Function</span>(&<span class="variable">quot</span>;<span class="variable">env</span>&<span class="variable">quot</span>;, <span class="variable">source</span>);
			}

		};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<pre><code>	 * Get a template by its id
	 * @param id
	 * @returns a template
	 </code></pre>
</td>
<td class="code">
<pre><code><span class="this">this</span>.<span class="variable">get</span> = <span class="keyword">function</span>(<span class="variable">id</span>) {
			<span class="keyword">return</span> <span class="this">this</span>.<span class="variable">templates</span>[<span class="variable">id</span>];
		};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<pre><code>	 * Add a new template instance and compile it
	 * @param id {string} he id by which this new tempalte can be called
	 * @param source {string} the source of the template to compile
	 * @param environParam {object} specific environment data to be made available during rendering
	 * @param optionsParam {object} options, none for now
	 </code></pre>
</td>
<td class="code">
<pre><code><span class="this">this</span>.<span class="variable">add</span> = <span class="keyword">function</span> <span class="variable">add</span>(<span class="variable">id</span>, <span class="variable">source</span>, <span class="variable">environParam</span>, <span class="variable">optionsParam</span>) {
			<span class="keyword">var</span> <span class="variable">options</span> = {},
				<span class="variable">environ</span> = {
					<span class="class">Env</span>: <span class="class">Env</span>,
					<span class="variable">dali</span>: <span class="variable">dali</span>
				};
			<span class="variable">extend</span>(<span class="variable">options</span>, <span class="variable">optionsParam</span>);
			<span class="variable">extend</span>(<span class="variable">environ</span>, <span class="variable">environParam</span>);
			<span class="keyword">return</span> <span class="variable">dali</span>.<span class="variable">templates</span>[<span class="variable">id</span>] = <span class="keyword">new</span> <span class="variable">dali</span>.<span class="class">Template</span>(<span class="variable">id</span>, <span class="variable">source</span>, <span class="variable">environ</span>, <span class="variable">options</span>);
		};

		<span class="keyword">function</span> <span class="class">Env</span>() {
			<span class="this">this</span>.<span class="variable">dali</span> = <span class="variable">dali</span>;
			<span class="this">this</span>.<span class="variable">render</span> = <span class="keyword">function</span> (<span class="variable">id</span>, <span class="variable">data</span>) {
				<span class="keyword">return</span> <span class="variable">dali</span>.<span class="variable">get</span>(<span class="variable">id</span>).<span class="variable">render</span>(<span class="variable">data</span>);
			};
			<span class="this">this</span>.<span class="variable">_stream</span> = [];
			<span class="this">this</span>.<span class="variable">out</span> = <span class="keyword">function</span> (<span class="variable">content</span>) {
				<span class="this">this</span>.<span class="variable">_stream</span>.<span class="variable">push</span>(<span class="variable">content</span>);
			};
			<span class="this">this</span>.<span class="variable">stream</span> = <span class="keyword">function</span> () {
				<span class="keyword">return</span> <span class="this">this</span>.<span class="variable">_stream</span>.<span class="variable">join</span>(&<span class="variable">quot</span>;&<span class="variable">quot</span>;);
			};
			<span class="this">this</span>.<span class="variable">applyTag</span> = <span class="keyword">function</span> (<span class="variable">tagName</span>, <span class="variable">args</span>, <span class="variable">data</span>, <span class="variable">blockHandler</span>) {
				<span class="keyword">var</span> <span class="variable">content</span>,
					<span class="variable">newEnv</span> = <span class="keyword">new</span> <span class="class">Env</span>(),
					<span class="variable">tag</span> = <span class="variable">tags</span>[<span class="variable">tagName</span>];
				<span class="variable">content</span> = <span class="variable">tag</span>.<span class="variable">apply</span>(<span class="variable">data</span>, [<span class="variable">args</span>, <span class="variable">newEnv</span>, <span class="variable">blockHandler</span>]);
				<span class="this">this</span>.<span class="variable">out</span>(<span class="variable">content</span>);
			};
			<span class="this">this</span>.<span class="variable">applyDecorator</span> = <span class="keyword">function</span>(<span class="variable">decoratorName</span>, <span class="variable">args</span>) {
				<span class="keyword">var</span> <span class="variable">str</span>,
					<span class="variable">decorator</span> = <span class="variable">decorators</span>[<span class="variable">decoratorName</span>],
					<span class="variable">oldArray</span> = <span class="this">this</span>.<span class="variable">_stream</span>,
					<span class="variable">newArray</span> = [];
				<span class="keyword">if</span> (<span class="keyword">typeof</span>(<span class="variable">decorator</span>) !== &<span class="variable">quot</span>;<span class="keyword">function</span>&<span class="variable">quot</span>;) <span class="keyword">throw</span>(<span class="keyword">new</span> <span class="class">Error</span>(&<span class="variable">quot</span>;<span class="class">Unknown</span> <span class="variable">decorator</span>: &<span class="variable">quot</span>; + <span class="variable">decoratorName</span>));
				<span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">oldArray</span>) {
					<span class="variable">str</span> = <span class="variable">decorator</span>.<span class="variable">apply</span>(<span class="variable">oldArray</span>[<span class="variable">i</span>] + &<span class="variable">quot</span>;&<span class="variable">quot</span>;, <span class="variable">args</span>);
					<span class="variable">newArray</span>.<span class="variable">push</span>(<span class="variable">str</span>);
				}
				<span class="this">this</span>.<span class="variable">_stream</span> = <span class="variable">newArray</span>;
			};
		}

	}


	<span class="comment">// todo: Refactor: Cut the lexer in smaller functions</span>
	<span class="keyword">function</span> <span class="variable">lexer</span>(<span class="variable">template</span>) {
		<span class="keyword">var</span> <span class="variable">tag</span>,
			<span class="variable">tagsMatch</span>,
			<span class="variable">before</span>,
			<span class="variable">lastTagStart</span>,
			<span class="variable">lastTagEnd</span>,
			<span class="variable">endSplit</span>,
			<span class="variable">content</span>,
			<span class="variable">segments</span>,
			<span class="variable">args</span>,
			<span class="variable">decorator</span>,
			<span class="variable">decorators</span>,
			<span class="variable">i</span>,
			<span class="variable">j</span>,
			<span class="variable">tagName</span>,
			<span class="variable">tagType</span>,
			<span class="variable">tree</span>, <span class="comment">// a tree representing the tag structure to be rendered</span>
			<span class="variable">treeStack</span>, <span class="comment">// A stack of tagNodePointers used during recursion</span>
			<span class="variable">tagNode</span>, <span class="comment">// to store newly created tagNodes</span>
			<span class="variable">tagNodePointer</span>; <span class="comment">// points to the last tagNode being processed</span>

		<span class="variable">tagsMatch</span> = <span class="variable">template</span>.<span class="variable">match</span>(<span class="regexp">/{(.*?)}/gm</span>) || [];
		<span class="variable">lastTagEnd</span> = <span class="number integer">0</span>;
		<span class="variable">tree</span> = [];
		<span class="variable">treeStack</span> = [];


		<span class="comment">// Create the root TagNode</span>
		<span class="variable">tagNode</span> = <span class="variable">tagNodePointer</span> = <span class="keyword">new</span> <span class="class">TagNode</span>(&<span class="variable">quot</span>;<span class="variable">out</span>&<span class="variable">quot</span>;, &<span class="variable">quot</span>;&<span class="variable">quot</span>;);
		<span class="variable">tree</span>.<span class="variable">push</span>(<span class="variable">tagNode</span>);
		<span class="variable">treeStack</span>.<span class="variable">push</span>(<span class="variable">tagNode</span>);

		<span class="keyword">for</span> (<span class="variable">i</span> <span class="keyword">in</span> <span class="variable">tagsMatch</span>) {
			<span class="keyword">if</span> (<span class="variable">tagsMatch</span>.<span class="variable">hasOwnProperty</span>(<span class="variable">i</span>)) {
				<span class="variable">tag</span> = <span class="variable">tagsMatch</span>[<span class="variable">i</span>];
				<span class="variable">lastTagStart</span> = <span class="variable">template</span>.<span class="variable">indexOf</span>(<span class="variable">tag</span>, <span class="variable">lastTagEnd</span>);
				<span class="variable">before</span> = <span class="variable">template</span>.<span class="variable">substring</span>(<span class="variable">lastTagEnd</span>, <span class="variable">lastTagStart</span>);
				<span class="keyword">if</span> (<span class="variable">before</span>.<span class="variable">length</span>) {
					<span class="variable">tagNodePointer</span>.<span class="variable">children</span>.<span class="variable">push</span>(<span class="keyword">new</span> <span class="class">TagNode</span>(&<span class="variable">quot</span>;<span class="variable">raw</span>&<span class="variable">quot</span>;, &<span class="variable">quot</span>;<span class="string">'&quot; + escape(before) + &quot;'</span>&<span class="variable">quot</span>;));
				}
				<span class="variable">tagName</span> = <span class="variable">tag</span>.<span class="variable">split</span>(&<span class="variable">quot</span>; &<span class="variable">quot</span>;)[<span class="number integer">0</span>].<span class="variable">substring</span>(<span class="number integer">1</span>);
				<span class="keyword">if</span> (<span class="variable">tagName</span>[<span class="number integer">0</span>] === &<span class="variable">quot</span>;/&<span class="variable">quot</span>;) {
					<span class="variable">tagType</span> = &<span class="variable">quot</span>;<span class="variable">closeTag</span>&<span class="variable">quot</span>;;
					<span class="comment">// Remove the trailing brace</span>
					<span class="variable">tagName</span> = <span class="variable">tagName</span>.<span class="variable">split</span>(&<span class="variable">quot</span>;}&<span class="variable">quot</span>;)[<span class="number integer">0</span>];
					<span class="variable">tagName</span> = <span class="variable">tagName</span>.<span class="variable">substring</span>(<span class="number integer">1</span>);
				} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">tag</span>.<span class="variable">substring</span>(<span class="variable">tag</span>.<span class="variable">length</span> -<span class="number integer">2</span>) === &<span class="variable">quot</span>;/}&<span class="variable">quot</span>;) {
					<span class="variable">tagType</span> = &<span class="variable">quot</span>;<span class="variable">tag</span>&<span class="variable">quot</span>;;
					<span class="variable">tagName</span> = <span class="variable">tagName</span>.<span class="variable">split</span>(&<span class="variable">quot</span>;/}&<span class="variable">quot</span>;)[<span class="number integer">0</span>];
				} <span class="keyword">else</span> {
					<span class="variable">tagName</span> = <span class="variable">tagName</span>.<span class="variable">split</span>(&<span class="variable">quot</span>;}&<span class="variable">quot</span>;)[<span class="number integer">0</span>];
					<span class="variable">tagType</span> = &<span class="variable">quot</span>;<span class="variable">openTag</span>&<span class="variable">quot</span>;;
				}

				<span class="keyword">var</span> <span class="variable">tagEnd</span> = (<span class="variable">tagType</span> === &<span class="variable">quot</span>;<span class="variable">tag</span>&<span class="variable">quot</span>;) ? &<span class="variable">quot</span>;/}&<span class="variable">quot</span>; : &<span class="variable">quot</span>;}&<span class="variable">quot</span>;;
				<span class="variable">content</span> = <span class="variable">tag</span>.<span class="variable">substring</span>(<span class="variable">tag</span>.<span class="variable">indexOf</span>(&<span class="variable">quot</span>;{&<span class="variable">quot</span>;)+<span class="number integer">1</span>, <span class="variable">tag</span>.<span class="variable">lastIndexOf</span>(<span class="variable">tagEnd</span>));
				<span class="variable">segments</span> = <span class="variable">content</span>.<span class="variable">split</span>(&<span class="variable">quot</span>;&<span class="variable">gt</span>;&<span class="variable">gt</span>;&<span class="variable">quot</span>;);
				<span class="variable">args</span> = &<span class="variable">quot</span>;&<span class="variable">quot</span>;;
				<span class="keyword">if</span> (<span class="variable">segments</span>[<span class="number integer">0</span>].<span class="variable">indexOf</span>(&<span class="variable">quot</span>; &<span class="variable">quot</span>;) &<span class="variable">gt</span>; -<span class="number integer">1</span>) {
					<span class="variable">args</span> = <span class="variable">segments</span>[<span class="number integer">0</span>].<span class="variable">substring</span>(<span class="variable">segments</span>[<span class="number integer">0</span>].<span class="variable">indexOf</span>(&<span class="variable">quot</span>; &<span class="variable">quot</span>;));
				}
				<span class="variable">decorators</span> = <span class="variable">segments</span>.<span class="variable">slice</span>(<span class="number integer">1</span>);

				<span class="comment">// opening a new scope</span>
				<span class="keyword">if</span> (<span class="keyword">typeof</span>(<span class="variable">tags</span>[<span class="variable">tagName</span>])!==&<span class="variable">quot</span>;<span class="keyword">function</span>&<span class="variable">quot</span>;)
					<span class="keyword">throw</span>(<span class="keyword">new</span> <span class="class">Error</span>(&<span class="variable">quot</span>;<span class="class">Unknown</span> <span class="variable">tag</span>:  &<span class="variable">quot</span>; + <span class="variable">tagName</span>));
				<span class="keyword">if</span> (<span class="variable">tagType</span> === &<span class="variable">quot</span>;<span class="variable">tag</span>&<span class="variable">quot</span>;) {
					<span class="variable">tagNode</span> = <span class="keyword">new</span> <span class="class">TagNode</span>(<span class="variable">tagName</span>, <span class="variable">args</span>);
					<span class="variable">tagNodePointer</span>.<span class="variable">children</span>.<span class="variable">push</span>(<span class="variable">tagNode</span>);
				} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">tagType</span> === &<span class="variable">quot</span>;<span class="variable">openTag</span>&<span class="variable">quot</span>; || <span class="variable">tagType</span> === &<span class="variable">quot</span>;<span class="variable">closeTag</span>&<span class="variable">quot</span>;) {
					<span class="keyword">if</span> (<span class="variable">tagType</span> === &<span class="variable">quot</span>;<span class="variable">openTag</span>&<span class="variable">quot</span>;) {
						<span class="variable">tagNode</span> = <span class="keyword">new</span> <span class="class">TagNode</span>(<span class="variable">tagName</span>, <span class="variable">args</span>);
						<span class="variable">tagNodePointer</span>.<span class="variable">children</span>.<span class="variable">push</span>(<span class="variable">tagNode</span>);
						<span class="variable">treeStack</span>.<span class="variable">push</span>(<span class="variable">tagNode</span>);
						<span class="variable">tagNodePointer</span> = <span class="variable">tagNode</span>;
					} <span class="keyword">else</span> {
						<span class="comment">// temporarelly move the pointer to the exiting scope and test to</span>
						<span class="comment">// see if the tag was properly closed</span>
						<span class="variable">tagNodePointer</span> = <span class="variable">treeStack</span>.<span class="variable">pop</span>();
						<span class="keyword">if</span> (<span class="variable">tagName</span> !== <span class="variable">tagNodePointer</span>.<span class="variable">name</span>)
							<span class="keyword">throw</span>(<span class="keyword">new</span> <span class="class">Error</span>(&<span class="variable">quot</span>;<span class="class">Badly</span> <span class="variable">closed</span> <span class="variable">tag</span>: <span class="variable">expected</span> <span class="string">'&quot; + tagNodePointer.name + &quot;'</span> <span class="variable">but</span> <span class="variable">got</span> <span class="string">'&quot; + tagName + &quot;'</span>&<span class="variable">quot</span>;));
						<span class="variable">tagNodePointer</span> = <span class="variable">treeStack</span>[<span class="variable">treeStack</span>.<span class="variable">length</span>-<span class="number integer">1</span>];
					}
				}

				<span class="comment">// Process chained decorators</span>
				<span class="keyword">var</span> <span class="variable">targetNode</span>;
				<span class="keyword">for</span> (<span class="variable">j</span> <span class="keyword">in</span> <span class="variable">decorators</span>) {
					<span class="variable">decorator</span> = <span class="variable">decorators</span>[<span class="variable">j</span>].<span class="variable">trim</span>();
					<span class="keyword">if</span> (<span class="variable">decorator</span>.<span class="variable">indexOf</span>(&<span class="variable">quot</span>;(&<span class="variable">quot</span>;) &<span class="variable">gt</span>; -<span class="number integer">1</span>) {
						<span class="variable">tagName</span> = <span class="variable">decorator</span>.<span class="variable">substring</span>(<span class="number integer">0</span>, <span class="variable">decorator</span>.<span class="variable">indexOf</span>(&<span class="variable">quot</span>;(&<span class="variable">quot</span>;));
						<span class="variable">args</span> = <span class="variable">decorator</span>.<span class="variable">substring</span>(<span class="variable">decorator</span>.<span class="variable">indexOf</span>(&<span class="variable">quot</span>;(&<span class="variable">quot</span>;));
						<span class="variable">args</span> = &<span class="variable">quot</span>;[&<span class="variable">quot</span>; + <span class="variable">args</span>.<span class="variable">substring</span>(<span class="number integer">1</span>, <span class="variable">args</span>.<span class="variable">lastIndexOf</span>(&<span class="variable">quot</span>;)&<span class="variable">quot</span>;)) + &<span class="variable">quot</span>;]&<span class="variable">quot</span>;;
					} <span class="keyword">else</span> {
						<span class="comment">// todo: setup a better and stricter parsing</span>
						<span class="variable">tagName</span> = <span class="variable">decorator</span>;
						<span class="variable">args</span> = &<span class="variable">quot</span>;[]&<span class="variable">quot</span>;;
					}
					<span class="variable">tagNode</span>.<span class="variable">decorators</span>.<span class="variable">push</span>(<span class="keyword">new</span> <span class="class">TagNode</span>(<span class="variable">tagName</span>, <span class="variable">args</span>));

				}
				<span class="comment">// move the cursor forward</span>
				<span class="variable">lastTagEnd</span> = <span class="variable">lastTagStart</span> + <span class="variable">tag</span>.<span class="variable">length</span>;
			}
		}
		<span class="comment">// Add a raw tag for the last piece to be renderec or if not tag are found</span>
		<span class="variable">before</span> = <span class="variable">template</span>.<span class="variable">substring</span>(<span class="variable">lastTagEnd</span>, <span class="variable">template</span>.<span class="variable">length</span>);
		<span class="keyword">if</span> (<span class="variable">before</span>.<span class="variable">length</span>) {
			<span class="variable">tagNodePointer</span>.<span class="variable">children</span>.<span class="variable">push</span>(<span class="keyword">new</span> <span class="class">TagNode</span>(&<span class="variable">quot</span>;<span class="variable">raw</span>&<span class="variable">quot</span>;, &<span class="variable">quot</span>;<span class="string">'&quot; + escape(before) + &quot;'</span>&<span class="variable">quot</span>;));
		}
		<span class="keyword">return</span> <span class="variable">compileNode</span>(<span class="variable">tree</span>[<span class="number integer">0</span>]);
	}

	<span class="keyword">function</span> <span class="class">TagNode</span>(<span class="variable">name</span>, <span class="variable">argString</span>) {
		<span class="this">this</span>.<span class="variable">name</span> = <span class="variable">name</span>;
		<span class="this">this</span>.<span class="variable">argString</span> = <span class="variable">argString</span>;
		<span class="this">this</span>.<span class="variable">children</span> = [];
		<span class="this">this</span>.<span class="variable">decorators</span> = [];
	}

	<span class="comment">// compile a tagNode and all its children into a javascript function</span>
	<span class="keyword">function</span> <span class="variable">compileNode</span>(<span class="variable">node</span>) {
		<span class="keyword">var</span> <span class="variable">i</span>,
			<span class="variable">stream</span> = [],
			<span class="variable">content</span>,
			<span class="variable">tagName</span>,
			<span class="variable">child</span>,
			<span class="variable">args</span>,
			<span class="variable">blockHandler</span>;
		<span class="comment">// Apply tags</span>
		<span class="keyword">for</span> (<span class="variable">i</span> <span class="keyword">in</span> <span class="variable">node</span>.<span class="variable">children</span>) {
			<span class="variable">child</span> = <span class="variable">node</span>.<span class="variable">children</span>[<span class="variable">i</span>];
			<span class="variable">tagName</span> = <span class="variable">child</span>.<span class="variable">name</span>;
			<span class="variable">content</span> = (<span class="variable">child</span>.<span class="variable">children</span>.<span class="variable">length</span> || <span class="variable">child</span>.<span class="variable">decorators</span>.<span class="variable">length</span>) ? <span class="variable">compileNode</span>(<span class="variable">child</span>) : &<span class="variable">quot</span>;&<span class="variable">quot</span>;;
			<span class="variable">args</span> = <span class="variable">unescape</span>(<span class="variable">child</span>.<span class="variable">argString</span>).<span class="variable">trim</span>();
			<span class="variable">blockHandler</span> = (<span class="variable">content</span>) ? &<span class="variable">quot</span>;<span class="keyword">function</span> (<span class="variable">env</span>, <span class="variable">args</span>) {\<span class="variable">n</span>&<span class="variable">quot</span>; + <span class="variable">content</span> + &<span class="variable">quot</span>;}&<span class="variable">quot</span>; : <span class="keyword">null</span>;
			<span class="variable">stream</span>.<span class="variable">push</span>(&<span class="variable">quot</span>;<span class="variable">env</span>.<span class="variable">applyTag</span>(<span class="string">'&quot; + tagName + &quot;'</span>, [&<span class="variable">quot</span>; + <span class="variable">args</span> + &<span class="variable">quot</span>;], <span class="this">this</span>, &<span class="variable">quot</span>; + <span class="variable">blockHandler</span> + &<span class="variable">quot</span>;);\<span class="variable">n</span>&<span class="variable">quot</span>;);
		}
		<span class="comment">// Apply decorator functions</span>
		<span class="keyword">for</span> (<span class="variable">i</span> <span class="keyword">in</span> <span class="variable">node</span>.<span class="variable">decorators</span>) {
			<span class="variable">child</span> = <span class="variable">node</span>.<span class="variable">decorators</span>[<span class="variable">i</span>];
			<span class="variable">stream</span>.<span class="variable">push</span>(&<span class="variable">quot</span>;<span class="variable">env</span>.<span class="variable">applyDecorator</span>(<span class="string">'&quot; + child.name + &quot;'</span>, &<span class="variable">quot</span>; + <span class="variable">child</span>.<span class="variable">argString</span> + &<span class="variable">quot</span>;);\<span class="variable">n</span>&<span class="variable">quot</span>;);
		}
		<span class="keyword">return</span> <span class="variable">stream</span>.<span class="variable">join</span>(&<span class="variable">quot</span>;&<span class="variable">quot</span>;);
	}

	<span class="keyword">var</span> <span class="variable">tags</span> = {
		&<span class="variable">quot</span>;<span class="variable">raw</span>&<span class="variable">quot</span>; : <span class="keyword">function</span>(<span class="variable">args</span>, <span class="variable">env</span>, <span class="variable">blockHandler</span>) {
			<span class="keyword">return</span> <span class="variable">args</span>.<span class="variable">join</span>(&<span class="variable">quot</span>;&<span class="variable">quot</span>;);
		},
		&<span class="variable">quot</span>;<span class="keyword">if</span>&<span class="variable">quot</span>; : <span class="keyword">function</span>(<span class="variable">args</span>, <span class="variable">env</span>, <span class="variable">blockHandler</span>) {
			<span class="keyword">if</span> (<span class="variable">args</span>[<span class="number integer">0</span>]) {
				<span class="variable">blockHandler</span>.<span class="variable">apply</span>(<span class="this">this</span>, [<span class="variable">env</span>, <span class="variable">args</span>]);
			}
			<span class="keyword">return</span> <span class="variable">env</span>.<span class="variable">stream</span>();
		},
		&<span class="variable">quot</span>;#&<span class="variable">quot</span>; : <span class="keyword">function</span>(<span class="variable">args</span>, <span class="variable">env</span>, <span class="variable">blockHandler</span>) {
			<span class="keyword">return</span> &<span class="variable">quot</span>;&<span class="variable">quot</span>;;
		},
		&<span class="variable">quot</span>;<span class="variable">each</span>&<span class="variable">quot</span>; : <span class="keyword">function</span>(<span class="variable">args</span>, <span class="variable">env</span>, <span class="variable">blockHandler</span>) {
			<span class="keyword">var</span> <span class="variable">i</span>, <span class="variable">item</span>, <span class="variable">items</span>;
			<span class="variable">items</span> = <span class="variable">args</span>[<span class="number integer">0</span>];
			<span class="keyword">if</span> (<span class="keyword">typeof</span>(<span class="variable">blockHandler</span>) === &<span class="variable">quot</span>;<span class="keyword">function</span>&<span class="variable">quot</span>;) {
				<span class="keyword">for</span> (<span class="variable">i</span> <span class="keyword">in</span> <span class="variable">items</span>) {
					<span class="variable">item</span> = <span class="variable">items</span>[<span class="variable">i</span>];
					<span class="variable">blockHandler</span>.<span class="variable">apply</span>(<span class="variable">item</span>, [<span class="variable">env</span>, <span class="variable">args</span>]);
				}
			}
			<span class="keyword">return</span> <span class="variable">env</span>.<span class="variable">stream</span>();
		},
		&<span class="variable">quot</span>;<span class="variable">out</span>&<span class="variable">quot</span>; : <span class="keyword">function</span>(<span class="variable">args</span>, <span class="variable">env</span>, <span class="variable">blockHandler</span>) {
			<span class="variable">env</span>.<span class="variable">out</span>(<span class="variable">args</span>.<span class="variable">join</span>(&<span class="variable">quot</span>;&<span class="variable">quot</span>;));
			<span class="keyword">if</span> (<span class="variable">blockHandler</span>) {
				<span class="variable">blockHandler</span>.<span class="variable">apply</span>(<span class="this">this</span>, [<span class="variable">env</span>, <span class="variable">args</span>]);
			}
			<span class="keyword">return</span> <span class="variable">env</span>.<span class="variable">stream</span>();
		},
		&<span class="variable">quot</span>;<span class="variable">render</span>&<span class="variable">quot</span>; : <span class="keyword">function</span>(<span class="variable">args</span>, <span class="variable">env</span>, <span class="variable">blockHandler</span>) {
			<span class="variable">env</span>.<span class="variable">out</span>(<span class="variable">env</span>.<span class="variable">render</span>(<span class="variable">args</span>[<span class="number integer">0</span>], <span class="variable">args</span>[<span class="number integer">1</span>]));
			<span class="keyword">return</span> <span class="variable">env</span>.<span class="variable">stream</span>();
		}
	};

	<span class="keyword">var</span> <span class="variable">decorators</span> = {
		<span class="variable">trim</span>: <span class="keyword">function</span>(<span class="variable">args</span>) {
			<span class="keyword">return</span> (<span class="this">this</span>+&<span class="variable">quot</span>;&<span class="variable">quot</span>;).<span class="variable">trim</span>();
		},
		<span class="variable">uppercase</span>: <span class="keyword">function</span>(<span class="variable">args</span>) {
			<span class="keyword">return</span> (<span class="this">this</span>+&<span class="variable">quot</span>;&<span class="variable">quot</span>;).<span class="variable">toUpperCase</span>();
		},
		<span class="variable">lowercase</span>: <span class="keyword">function</span>(<span class="variable">args</span>) {
			<span class="keyword">return</span> (<span class="this">this</span>+&<span class="variable">quot</span>;&<span class="variable">quot</span>;).<span class="variable">toLowerCase</span>();
		}
	};

	<span class="comment">// Create Global &quot;extend&quot; method</span>
	<span class="keyword">function</span> <span class="variable">extend</span>(<span class="variable">obj</span>, <span class="variable">extObj</span>) {
		<span class="keyword">if</span> (<span class="variable">arguments</span>.<span class="variable">length</span> &<span class="variable">gt</span>; <span class="number integer">2</span>) {
			<span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">a</span> = <span class="number integer">1</span>; <span class="variable">a</span> &<span class="variable">lt</span>; <span class="variable">arguments</span>.<span class="variable">length</span>; <span class="variable">a</span>++) {
				<span class="variable">extend</span>(<span class="variable">obj</span>, <span class="variable">arguments</span>[<span class="variable">a</span>]);
			}
		} <span class="keyword">else</span> {
			<span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="variable">extObj</span>) {
				<span class="variable">obj</span>[<span class="variable">i</span>] = <span class="variable">extObj</span>[<span class="variable">i</span>];
			}
		}
		<span class="keyword">return</span> <span class="variable">obj</span>;
	}

	<span class="keyword">function</span> <span class="variable">escape</span>(<span class="variable">str</span>) {
		<span class="comment">// Linefeeds</span>
		<span class="variable">str</span> = <span class="variable">str</span>.<span class="variable">replace</span>(<span class="regexp">/\n/g</span>, &<span class="variable">quot</span>;%<span class="variable">lf</span>%&<span class="variable">quot</span>;);
		<span class="keyword">return</span> <span class="variable">str</span>;
	}

	<span class="keyword">function</span> <span class="variable">unescape</span>(<span class="variable">str</span>) {
		<span class="comment">// Linefeeds</span>
		<span class="variable">str</span> = <span class="variable">str</span>.<span class="variable">replace</span>(<span class="regexp">/%lf%/g</span>, &<span class="variable">quot</span>;\\<span class="variable">n</span>&<span class="variable">quot</span>;);
		<span class="comment">// html entities</span>
		<span class="variable">str</span> = <span class="variable">str</span>.<span class="variable">replace</span>(<span class="regexp">/&gt;/g</span>, &<span class="variable">quot</span>;&<span class="variable">gt</span>;&<span class="variable">quot</span>;).<span class="variable">replace</span>(<span class="regexp">/&lt;/g</span>, &<span class="variable">quot</span>;&<span class="variable">lt</span>;&<span class="variable">quot</span>;);
		<span class="keyword">return</span> <span class="variable">str</span>;
	}


	<span class="variable">exportContent</span>.<span class="variable">dali</span> = <span class="keyword">function</span> (<span class="variable">options</span>) {
		<span class="keyword">return</span> <span class="keyword">new</span> <span class="class">Dali</span>(<span class="variable">options</span>)
	}
})(<span class="variable">exports</span> || <span class="variable">dali</span>);


</code></pre>
</td>
</tr>	</body>
</html></tbody></table>